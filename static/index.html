<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directum | –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root {
            --directum-blue: #005eb8; 
            --directum-dark: #004077;
            --bg-gray: #f5f7fa;
            --text-dark: #333333;
        }

        body {
            background-color: var(--bg-gray);
            font-family: 'Roboto', 'Segoe UI', Tahoma, sans-serif;
            color: var(--text-dark);
            padding-bottom: 40px;
        }

        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-bottom: 3px solid var(--directum-blue);
            padding: 15px 0;
            margin-bottom: 30px;
        }

        .brand-logo {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--directum-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
        }
        
        .brand-logo span {
            color: var(--directum-blue);
        }

        .page-title {
            border-left: 1px solid #ddd;
            padding-left: 20px;
            margin-left: 20px;
            color: #666;
            font-weight: 400;
            font-size: 1.2rem;
        }

        .main-layout {
            display: flex;
            gap: 20px;
        }

        .main-content {
            flex: 1;
            min-width: 0;
        }

        .sidebar {
            width: 320px;
            flex-shrink: 0;
        }

        .table-card {
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            border: 1px solid #e1e4e8;
            padding: 0;
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead {
            background-color: #f8f9fa;
        }

        .table thead th {
            color: var(--directum-dark);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e9ecef;
            padding: 15px;
            vertical-align: top;
        }

        .table tbody td {
            padding: 12px 15px;
            vertical-align: top; 
            font-size: 0.95rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .table-hover tbody tr:hover {
            background-color: #f0f7ff;
        }

        .theme-cell {
            min-width: 200px;
            max-width: 350px;
            white-space: normal;
            line-height: 1.4;
        }
        
        .badge-theme {
            background-color: #e3f2fd;
            color: var(--directum-dark);
            font-weight: 500;
            border: 1px solid #bbdefb;
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-block;
            text-align: left;
            white-space: normal;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .badge-theme:hover {
            background-color: #bbdefb;
        }
        
        .badge-theme.active {
            background-color: var(--directum-blue);
            color: white;
            border-color: var(--directum-dark);
        }

        .clickable-preview {
            color: var(--directum-blue);
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            border-bottom: 1px dashed var(--directum-blue);
            transition: all 0.2s;
            display: inline-block;
        }
        
        .clickable-preview:hover {
            color: var(--directum-dark);
            border-bottom-style: solid;
        }

        .modal-header {
            background-color: var(--directum-dark);
            color: white;
            border-bottom: none;
        }
        
        .modal-title {
            font-weight: 300;
        }
        
        .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        #modalContent {
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            color: #333;
            background-color: #fafafa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .user-initials {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            min-width: 32px;
            background-color: #e9ecef;
            color: var(--directum-dark);
            border-radius: 50%;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 10px;
        }

        .date-text {
            color: #6c757d;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .sidebar-card {
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            border: 1px solid #e1e4e8;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sidebar-card h5 {
            color: var(--directum-dark);
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .selected-count {
            background: var(--directum-blue);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .loading-more {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .checkbox-column {
            width: 50px;
            text-align: center;
        }

        .filter-section {
            margin-bottom: 15px;
        }

        .filter-section label {
            font-weight: 500;
            color: var(--directum-dark);
            margin-bottom: 8px;
            display: block;
        }

        .btn-settings {
            background: none;
            border: none;
            color: var(--directum-dark);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            transition: color 0.2s;
        }

        .btn-settings:hover {
            color: var(--directum-blue);
        }

        #analysisResult {
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            background-color: #fafafa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #eee;
            max-height: 400px;
            overflow-y: auto;
        }

        .streaming-indicator {
            color: var(--directum-blue);
            font-style: italic;
        }
        
        .theme-filter-list {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            padding: 10px;
        }
        
        .theme-filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            cursor: pointer;
        }
        
        .theme-filter-item:hover {
            background-color: #f5f7fa;
        }
    </style>
</head>
<body>

<nav class="navbar sticky-top">
    <div class="container-fluid px-4">
        <div class="d-flex align-items-center">
            <div class="brand-logo">
                Directum <span>Sales</span>
            </div>
            <div class="page-title d-none d-md-block">
                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid px-4">
    <div class="main-layout">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å —Ç–∞–±–ª–∏—Ü–µ–π -->
        <div class="main-content">
            <div class="table-card">
                <div class="table-responsive">
                    <table class="table table-hover" id="resultsTable">
                        <thead>
                            <tr>
                                <th class="checkbox-column">‚úì</th>
                                <th style="width: 50px;">ID</th>
                                <th style="width: 140px;">–î–∞—Ç–∞ –≤—ã–±–æ—Ä–∞</th>
                                <th style="width: 140px;">–î–∞—Ç–∞ –æ—Ç–≤–µ—Ç–∞</th>
                                <th style="min-width: 200px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                <th>–¢–µ–º–∞</th>
                                <th style="min-width: 170px;">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                <th style="min-width: 130px;">–û—Ç–≤–µ—Ç</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="8" class="text-center py-5 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="loading-more d-none" id="loadingMore">
                –ó–∞–≥—Ä—É–∑–∫–∞ –µ—â—ë –¥–∞–Ω–Ω—ã—Ö...
            </div>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar">
            <div class="sidebar-card">
                <h5>
                    –ê–Ω–∞–ª–∏–∑
                    <button class="btn-settings" onclick="openSettingsModal()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–º—Ç–∞">‚öôÔ∏è</button>
                </h5>
                
                <div class="mb-3">
                    <span class="selected-count" id="selectedCount">0 –≤—ã–±—Ä–∞–Ω–æ</span>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-sm" id="analyzeBtn" onclick="analyzeAnswers()" disabled>
                        üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                        –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
                    </button>
                </div>
            </div>

            <div class="sidebar-card">
                <h5>–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–º–∞–º</h5>
                <div class="theme-filter-list" id="themeFilterList">
                    <div class="text-muted small">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º...</div>
                </div>
                <button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="clearThemeFilter()">
                    –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä
                </button>
            </div>

            <div class="sidebar-card">
                <h5>–§–∏–ª—å—Ç—Ä –ø–æ –æ—Ü–µ–Ω–∫–µ</h5>
                <div class="theme-filter-list" id="scoreFilterList">
                    <div class="text-muted small">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫...</div>
                </div>
                <button class="btn btn-outline-secondary btn-sm w-100 mt-2" onclick="clearScoreFilter()">
                    –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä
                </button>
            </div>
        </div>
    </div>
    
    <div class="text-center mt-4 text-muted small">
        &copy; 2025 Directum Internal Services
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–µ–∫—Å—Ç–∞ -->
<div class="modal fade" id="textModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="modalContent"></div>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ–º—Ç–∞ -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
            <label for="analysisPrompt" class="form-label fw-bold">–ü—Ä–æ–º—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:</label>
            <textarea class="form-control" id="analysisPrompt" rows="5">–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –æ–±–æ–±—â–∏ –Ω–∞–∏–±–æ–ª–µ–µ —è–≤–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –¥–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –ò–≥–Ω–æ—Ä–∏—Ä—É–π –Ω–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∏ —Ç–µ—Ä–º–∏–Ω–∞—Ö, —Ç.–∫. —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏.</textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button type="button" class="btn btn-primary btn-sm" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="analysisResult"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="downloadResult()">
            üíæ –°–∫–∞—á–∞—Ç—å .md
        </button>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    let currentOffset = 0;
    const defaultLimit = 20;
    let currentLimit = parseInt(localStorage.getItem('salesViewer_pageSize')) || defaultLimit;
    let isLoading = false;
    let hasMore = true;
    let totalRecords = 0;

    // –í—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    let selectedAnswers = new Map();
    
    // –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–º—ã
    let allThemes = [];
    let activeThemeFilter = null;
    
    // –í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏
    let allScores = [];
    let activeScoreFilter = null;
    
    // –î–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (–¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏)
    let allTableData = [];

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º—Ç–∞ –∏–∑ localStorage
    function loadPrompt() {
        const saved = localStorage.getItem('salesViewer_analysisPrompt');
        return saved || '–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏ –æ–±–æ–±—â–∏ –Ω–∞–∏–±–æ–ª–µ–µ —è–≤–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –¥–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –ò–≥–Ω–æ—Ä–∏—Ä—É–π –Ω–µ–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∏ —Ç–µ—Ä–º–∏–Ω–∞—Ö, —Ç.–∫. —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏.';
    }
    
    function savePrompt() {
        const prompt = document.getElementById('analysisPrompt').value;
        localStorage.setItem('salesViewer_analysisPrompt', prompt);
    }

    function formatMskDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        return date.toLocaleString("ru-RU", {
            timeZone: "Europe/Moscow",
            day: "2-digit", month: "2-digit", year: "numeric",
            hour: "2-digit", minute: "2-digit"
        });
    }

    function createPreview(text, type) {
        if (!text) return '<span class="text-muted">-</span>';
        let previewText = text.slice(0, 50) + "...";
        if (type === 'result') {
            const match = text.match(/–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:\s*\d+/i);
            if (match) previewText = match[0];
        } else {
             previewText = text.slice(0, 40) + (text.length > 40 ? "..." : "");
        }

        return `<span class="clickable-preview" onclick="openModal('${type}', this)">${previewText}</span>
                <div class="full-text d-none">${text.replace(/"/g, '&quot;')}</div>`;
    }

    function getInitials(fullName) {
        const parts = fullName.split(' ');
        if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
        return fullName.slice(0, 2).toUpperCase();
    }
	
	function formatUserWithLink(fullName) {
        const match = fullName.match(/^(.*?)\s*\((.*?)\)$/);
        if (match && match[2] && match[2] !== 'no_user') {
            const name = match[1];
            const username = match[2];
            return `${name} (<a href="https://t.me/${username}" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å Telegram" style="color: var(--directum-blue); text-decoration: none; border-bottom: 1px dotted var(--directum-blue);">${username}</a>)`;
        }
        return fullName;
    }

    function openModal(type, element) {
        const fullTextDiv = element.nextElementSibling;
        const fullText = fullTextDiv.innerHTML
            .replace(/&quot;/g, '"')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>');
        const title = type === 'result' ? '–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –ò–ò' : '–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalContent').textContent = fullText;
        const modal = new bootstrap.Modal(document.getElementById('textModal'));
        modal.show();
    }

    function openSettingsModal() {
        document.getElementById('analysisPrompt').value = loadPrompt();
        const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
        modal.show();
    }
    
    function saveSettings() {
        savePrompt();
        const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
        modal.hide();
    }

    function updateSelectedCount() {
        document.getElementById('selectedCount').textContent = `${selectedAnswers.size} –≤—ã–±—Ä–∞–Ω–æ`;
        document.getElementById('analyzeBtn').disabled = selectedAnswers.size === 0;
    }

    function toggleSelection(id) {
        if (selectedAnswers.has(id)) {
            selectedAnswers.delete(id);
        } else {
            const row = allTableData.find(r => r.id === id);
            if (row) {
                selectedAnswers.set(id, row);
            }
        }
        updateSelectedCount();
    }

    function clearSelection() {
        selectedAnswers.clear();
        document.querySelectorAll('.answer-checkbox').forEach(cb => cb.checked = false);
        updateSelectedCount();
    }

    // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    function extractScore(resultText) {
        if (!resultText) return null;
        const match = resultText.match(/–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:\s*(\d+)/i);
        return match ? parseInt(match[1]) : null;
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–µ–º
    function extractUniqueThemes(data) {
        const themesMap = new Map();
        data.forEach(row => {
            if (row.theme_name && !themesMap.has(row.theme_name)) {
                themesMap.set(row.theme_name, row.theme_name);
            }
        });
        return Array.from(themesMap.values()).sort();
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ—Ü–µ–Ω–æ–∫
    function extractUniqueScores(data) {
        const scoresSet = new Set();
        data.forEach(row => {
            const score = extractScore(row.result);
            if (score !== null) {
                scoresSet.add(score);
            }
        });
        return Array.from(scoresSet).sort((a, b) => a - b);
    }
    
    function renderThemeFilter(themes) {
        const container = document.getElementById('themeFilterList');
        container.innerHTML = themes.map(theme => {
            const isActive = activeThemeFilter === theme ? 'active' : '';
            return `
                <label class="theme-filter-item">
                    <input type="checkbox" value="${theme}" 
                           ${activeThemeFilter === theme ? 'checked' : ''}
                           onchange="setThemeFilter('${theme}')">
                    <span class="badge badge-theme ${isActive}">${theme}</span>
                </label>
            `;
        }).join('');
    }
    
    function renderScoreFilter(scores) {
        const container = document.getElementById('scoreFilterList');
        container.innerHTML = scores.map(score => {
            const isActive = activeScoreFilter === score;
            return `
                <label class="theme-filter-item">
                    <input type="checkbox" value="${score}" 
                           ${isActive ? 'checked' : ''}
                           onchange="setScoreFilter(${score})">
                    <span class="badge badge-theme ${isActive ? 'active' : ''}">${score}</span>
                </label>
            `;
        }).join('');
    }
    
    async function setThemeFilter(theme) {
        if (activeThemeFilter === theme) {
            activeThemeFilter = null;
        } else {
            activeThemeFilter = theme;
        }
        
        // –ï—Å–ª–∏ –≤–∫–ª—é—á–∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä ‚Äî –ø–æ–¥–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        if (activeThemeFilter) {
            currentOffset = 0;
            hasMore = true;
            allTableData = [];
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="8" class="text-center py-5 text-muted">–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞...</td></tr>';
            
            // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ—Ä—Ü–∏—è–º–∏
            while (hasMore) {
                await loadData(true, false);
            }
            allScores = extractUniqueScores(allTableData);
            renderThemeFilter(allThemes);
            renderScoreFilter(allScores);
            renderTable();
        } else {
            // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞ ‚Äî –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
            currentOffset = 0;
            hasMore = true;
            allTableData = [];
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="8" class="text-center py-5 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>';
            await loadData(false, true);
        }
    }
    
    async function clearThemeFilter() {
        activeThemeFilter = null;
        currentOffset = 0;
        hasMore = true;
        allTableData = [];
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="8" class="text-center py-5 text-muted">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>';
        await loadData(false, true);
    }
    
    async function setScoreFilter(score) {
        if (activeScoreFilter === score) {
            activeScoreFilter = null;
        } else {
            activeScoreFilter = score;
        }
        renderScoreFilter(allScores);
        renderTable();
    }
    
    function clearScoreFilter() {
        activeScoreFilter = null;
        renderScoreFilter(allScores);
        renderTable();
    }

    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    function getFilteredData() {
        let filtered = allTableData;
        
        if (activeThemeFilter) {
            filtered = filtered.filter(row => row.theme_name === activeThemeFilter);
        }
        
        if (activeScoreFilter !== null) {
            filtered = filtered.filter(row => extractScore(row.result) === activeScoreFilter);
        }
        
        return filtered;
    }

    // –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        const filteredData = getFilteredData();
        
        if (filteredData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5 text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ñ–∏–ª—å—Ç—Ä—É</td></tr>';
            return;
        }

        filteredData.forEach(row => {
            const tr = document.createElement('tr');
            tr.dataset.id = row.id;
            
            const cleanName = row.full_name.split('(')[0].trim();
            const initials = getInitials(cleanName);
            const isSelected = selectedAnswers.has(row.id);

            tr.innerHTML = `
                <td class="checkbox-column">
                    <input type="checkbox" class="form-check-input answer-checkbox" 
                           ${isSelected ? 'checked' : ''} 
                           onchange="toggleSelection(${row.id})">
                </td>
                <td class="text-muted small">${row.id}</td>
                <td><div class="date-text">${formatMskDate(row.created_at)}</div></td>
                <td><div class="date-text">${formatMskDate(row.answered_at)}</div></td>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="user-initials flex-shrink-0">${initials}</div>
                        <div>${formatUserWithLink(row.full_name)}</div>
                    </div>
                </td>
                <td>
                    <div class="theme-cell">
                        <span class="badge badge-theme">${row.theme_name}</span>
                    </div>
                </td>
                <td>${createPreview(row.result, 'result')}</td>
                <td>${createPreview(row.user_answer, 'answer')}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function loadData(append = false, render = true) {
        if (isLoading || !hasMore) return;
        
        isLoading = true;

        try {
            const response = await fetch(`/api/data?offset=${currentOffset}&limit=${currentLimit}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            const result = await response.json();
            
            if (!append) {
                allTableData = [];
                currentOffset = 0;
            }

            totalRecords = result.total;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            result.data.forEach(row => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ ID
                if (!allTableData.find(r => r.id === row.id)) {
                    allTableData.push(row);
                }
            });
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã –∏ –æ—Ü–µ–Ω–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
            if (!append) {
                allThemes = extractUniqueThemes(allTableData);
                allScores = extractUniqueScores(allTableData);
                renderThemeFilter(allThemes);
                renderScoreFilter(allScores);
            }

            // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–∞–±–ª–∏—Ü—É —Å —É—á—ë—Ç–æ–º —Ñ–∏–ª—å—Ç—Ä–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            if (render) {
                renderTable();
            }

            currentOffset += currentLimit;
            hasMore = currentOffset < totalRecords;
            
            if (hasMore) {
                document.getElementById('loadingMore').classList.remove('d-none');
            } else {
                document.getElementById('loadingMore').classList.add('d-none');
            }

        } catch (e) {
            console.error('Load error:', e);
            if (!append) {
                document.getElementById('tableBody').innerHTML = '<tr><td colspan="8" class="text-danger text-center py-4">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.</td></tr>';
            }
        } finally {
            isLoading = false;
        }
    }

    // –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
    window.addEventListener('scroll', () => {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            loadData(true);
        }
    });

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞
    let lastAnalysisResult = '';

    async function analyzeAnswers() {
        const answers = Array.from(selectedAnswers.values());
        const prompt = loadPrompt();
        
        if (!answers.length) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
            return;
        }

        const btn = document.getElementById('analyzeBtn');
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        const resultDiv = document.getElementById('analysisResult');
        
        btn.disabled = true;
        btn.textContent = '‚è≥ –ê–Ω–∞–ª–∏–∑...';
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
        resultDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">–ì–µ–Ω–µ—Ä–∏—Ä—É—é –∞–Ω–∞–ª–∏–∑...</p></div>';
        resultModal.show();
        lastAnalysisResult = '';

        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    selected_answers: answers,
                    prompt: prompt
                })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({ detail: '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞' }));
                throw new Error(error.detail || `HTTP ${response.status}`);
            }

            // –ü–æ—Ç–æ–∫–æ–≤–æ–µ —á—Ç–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            resultDiv.innerHTML = '';
            
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                
                const text = decoder.decode(value);
                lastAnalysisResult += text;
                resultDiv.textContent = lastAnalysisResult;
                resultDiv.scrollTop = resultDiv.scrollHeight;
            }

        } catch (e) {
            resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${e.message}`;
            lastAnalysisResult = `–û—à–∏–±–∫–∞: ${e.message}`;
        } finally {
            btn.disabled = false;
            btn.textContent = 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑';
        }
    }
    
    function downloadResult() {
        if (!lastAnalysisResult) {
            alert('–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
            return;
        }
        
        const blob = new Blob([lastAnalysisResult], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `analysis_${new Date().toISOString().slice(0,10)}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', async () => {
        await loadData();
    });
</script>
</body>
</html>
