<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directum | Результаты тестирования</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        :root {
            --directum-blue: #005eb8; 
            --directum-dark: #004077;
            --bg-gray: #f5f7fa;
            --text-dark: #333333;
        }

        body {
            background-color: var(--bg-gray);
            font-family: 'Roboto', 'Segoe UI', Tahoma, sans-serif;
            color: var(--text-dark);
            padding-bottom: 40px;
        }

        .navbar {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-bottom: 3px solid var(--directum-blue);
            padding: 15px 0;
            margin-bottom: 30px;
        }

        .brand-logo {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--directum-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
        }
        
        .brand-logo span {
            color: var(--directum-blue);
        }

        .page-title {
            border-left: 1px solid #ddd;
            padding-left: 20px;
            margin-left: 20px;
            color: #666;
            font-weight: 400;
            font-size: 1.2rem;
        }

        .table-card {
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            border: 1px solid #e1e4e8;
            padding: 0;
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead {
            background-color: #f8f9fa;
        }

        .table thead th {
            color: var(--directum-dark);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e9ecef;
            padding: 15px;
            vertical-align: top;
        }

        /* Выравниваем контент по верху, чтобы при высокой теме строки смотрелись аккуратно */
        .table tbody td {
            padding: 12px 15px;
            vertical-align: top; 
            font-size: 0.95rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .table-hover tbody tr:hover {
            background-color: #f0f7ff;
        }

        /* Стили для темы с переносом строк */
        .theme-cell {
            min-width: 200px;  /* Минимальная ширина, чтобы не сжималось совсем */
            max-width: 350px;  /* Ограничиваем ширину, чтобы не занимало пол-экрана */
            white-space: normal; /* Разрешаем перенос строк */
            line-height: 1.4;
        }
        
        .badge-theme {
            background-color: #e3f2fd;
            color: var(--directum-dark);
            font-weight: 500;
            border: 1px solid #bbdefb;
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-block; /* Важно для корректного отображения блоком */
            text-align: left;
            white-space: normal; /* Разрешаем перенос внутри бейджа */
        }

        .clickable-preview {
            color: var(--directum-blue);
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            border-bottom: 1px dashed var(--directum-blue);
            transition: all 0.2s;
            display: inline-block;
        }
        
        .clickable-preview:hover {
            color: var(--directum-dark);
            border-bottom-style: solid;
        }

        .modal-header {
            background-color: var(--directum-dark);
            color: white;
            border-bottom: none;
        }
        
        .modal-title {
            font-weight: 300;
        }
        
        .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        #modalContent {
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            color: #333;
            background-color: #fafafa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        
        .user-initials {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            min-width: 32px; /* Чтобы не сплющивалось */
            background-color: #e9ecef;
            color: var(--directum-dark);
            border-radius: 50%;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 10px;
        }

        .date-text {
            color: #6c757d;
            font-size: 0.85rem;
            white-space: nowrap; /* Даты в одну строку */
        }
    </style>
</head>
<body>

<nav class="navbar sticky-top">
    <div class="container-fluid px-4">
        <div class="d-flex align-items-center">
            <div class="brand-logo">
                Directum <span>Sales</span>
            </div>
            <div class="page-title d-none d-md-block">
                Результаты тестирования
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid px-4">
    <div class="table-card">
        <div class="table-responsive">
            <table class="table table-hover" id="resultsTable">
                <thead>
                    <tr>
                        <th style="width: 50px;">ID</th>
                        <th style="width: 140px;">Дата выбора</th>
                        <th style="width: 140px;">Дата ответа</th>
                        <th style="min-width: 200px;">Сотрудник</th>
                        <th>Тема</th>
                        <th style="min-width: 150px;">Результат</th>
                        <th style="min-width: 150px;">Ответ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="7" class="text-center py-5 text-muted">Загрузка данных...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="text-center mt-4 text-muted small">
        &copy; 2025 Directum Internal Services
    </div>
</div>

<div class="modal fade" id="textModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Просмотр данных</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="modalContent"></div>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function formatMskDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        return date.toLocaleString("ru-RU", {
            timeZone: "Europe/Moscow",
            day: "2-digit", month: "2-digit", year: "numeric",
            hour: "2-digit", minute: "2-digit"
        });
    }

    function createPreview(text, type) {
        if (!text) return '<span class="text-muted">-</span>';
        let previewText = text.slice(0, 50) + "...";
        if (type === 'result') {
            const match = text.match(/Итоговая оценка:\s*\d+/i);
            if (match) previewText = match[0];
        } else {
             previewText = text.slice(0, 40) + (text.length > 40 ? "..." : "");
        }

        return `<span class="clickable-preview" onclick="openModal('${type}', this)">${previewText}</span>
                <div class="full-text d-none">${text.replace(/"/g, '&quot;')}</div>`;
    }

    function getInitials(fullName) {
        const parts = fullName.split(' ');
        if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
        return fullName.slice(0, 2).toUpperCase();
    }
	
	function formatUserWithLink(fullName) {
        // Регулярка ищет формат "Имя Фамилия (username)"
        const match = fullName.match(/^(.*?)\s*\((.*?)\)$/);

        // Если нашли username и он не равен заглушке
        if (match && match[2] && match[2] !== 'no_user') {
            const name = match[1];
            const username = match[2];
            // Формируем ссылку. Стили inline, чтобы не лезть в CSS
            return `${name} (<a href="https://t.me/${username}" target="_blank" title="Открыть Telegram" style="color: var(--directum-blue); text-decoration: none; border-bottom: 1px dotted var(--directum-blue);">${username}</a>)`;
        }
        return fullName; // Если никнейма нет, возвращаем как было
    }

    function openModal(type, element) {
        const fullTextDiv = element.nextElementSibling;
        const fullText = fullTextDiv.innerHTML
            .replace(/&quot;/g, '"')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>');
        const title = type === 'result' ? 'Результат анализа ИИ' : 'Ответ пользователя';
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalContent').textContent = fullText;
        const modal = new bootstrap.Modal(document.getElementById('textModal'));
        modal.show();
    }

    async function loadData() {
        try {
            const response = await fetch('/api/data');
            const data = await response.json();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                
                const cleanName = row.full_name.split('(')[0].trim();
                const initials = getInitials(cleanName);

                tr.innerHTML = `
                    <td class="text-muted small">${row.id}</td>
                    <td><div class="date-text">${formatMskDate(row.created_at)}</div></td>
                    <td><div class="date-text">${formatMskDate(row.answered_at)}</div></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="user-initials flex-shrink-0">${initials}</div>
                            <div>${formatUserWithLink(row.full_name)}</div>
                        </div>
                    </td>
                    <td>
                        <div class="theme-cell">
                            <span class="badge badge-theme">${row.theme_name}</span>
                        </div>
                    </td>
                    <td>${createPreview(row.result, 'result')}</td>
                    <td>${createPreview(row.user_answer, 'answer')}</td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) {
            console.error(e);
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="text-danger text-center py-4">Не удалось загрузить данные. Проверьте соединение.</td></tr>';
        }
    }

    loadData();
</script>
</body>
</html>
